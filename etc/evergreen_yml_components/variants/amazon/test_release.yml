# Amazon build variants for testing release environments
#
# After the branching variants in this file
# should continue to run on a new rapid release (v7.1, v7.2 etc.)
# and LTS release (v7.0, v6.0 etc.) branch projects

buildvariants:
- name: amazon2
  display_name: "Amazon Linux 2"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-latest-small
  expansions:
    test_flags: >-
      --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-amazon2
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2
      --use_diagnostic_latches=False
      --build_enterprise=False
    multiversion_platform: amazon2
    multiversion_edition: targeted
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: amazon2
    repo_edition: org
    large_distro_name: amazon2-latest-large
    compile_variant: amazon2
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-latest-large
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .development_critical !.requires_large_host !.incompatible_community
  - name: .development_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2-latest-large
  - name: .release_critical !.requires_large_host !.incompatible_community
  - name: .release_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2-latest-large

- name: enterprise-amazon2
  display_name: "Enterprise Amazon Linux 2"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-latest-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd-stripped
      archive-mongocryptd-debug
    test_flags: >-
      --excludeWithAnyTags=SERVER-34286,incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer,requires_ldap_pool
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-amazon2
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2
      --use_diagnostic_latches=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    has_packages: true
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2
    repo_edition: enterprise
    compile_variant: enterprise-amazon2
    core_analyzer_distro_name: amazon2-latest-large
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-latest-large
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2-latest-large
  - name: .release_critical !.requires_large_host
  - name: .release_critical .requires_large_host
    distros:
    - amazon2-latest-large

- name: amazon2-arm64
  display_name: "Amazon Linux 2 arm64"
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-arm64-latest-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-amazon2
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2
      --use_diagnostic_latches=False
      --build_enterprise=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: >-
          --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
          --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: amazon2
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2-arm64-latest-large
    core_analyzer_distro_name: amazon2-arm64-latest-xlarge
    compile_variant: amazon2-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-arm64-latest-large
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .development_critical !.requires_large_host !.incompatible_community
  - name: .development_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2-arm64-latest-large
  - name: .release_critical !.requires_large_host !.incompatible_community
  - name: .release_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2-arm64-latest-large

- name: amazon2023
  display_name: "Amazon Linux 2023"
  tags: ["bazel_check"]
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.3-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: x86_64-amazon2023
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
      --use_diagnostic_latches=False
      --build_enterprise=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: >-
      --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: x86_64
    packager_distro: amazon2023
    repo_edition: org
    large_distro_name: amazon2023.3-large
    compile_variant: amazon2023
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.3-large
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .development_critical !.requires_large_host !.incompatible_community
  - name: .development_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2023.3-large
  - name: .release_critical !.requires_large_host !.incompatible_community
  - name: .release_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2023.3-large

- name: enterprise-amazon2023
  display_name: "Enterprise Amazon Linux 2023"
  tags: []
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.3-small
  expansions:
    additional_package_targets: archive-mongocryptd-stripped archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: x86_64-enterprise-amazon2023
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
      --use_diagnostic_latches=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: true
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: x86_64
    packager_script: packager_enterprise.py
    packager_arch: x86_64
    packager_distro: amazon2023
    repo_edition: enterprise
    compile_variant: enterprise-amazon2023
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.3-large
  - name: test_packages
    distros:
    - ubuntu2204-large
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2023.3-large
  - name: .release_critical !.requires_large_host
  - name: .release_critical .requires_large_host
    distros:
    - amazon2023.3-large


- name: amazon2023-arm64
  display_name: "Amazon Linux 2023 arm64"
  tags: ["bazel_check"]
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.3-arm64-small
  expansions:
    push_path: linux
    push_bucket: downloads.mongodb.org
    push_name: linux
    push_arch: aarch64-amazon2023
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
      --use_diagnostic_latches=False
      --build_enterprise=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: >-
      --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    has_packages: true
    packager_script: packager.py
    packager_arch: aarch64
    packager_distro: amazon2023
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2023.3-arm64-large
    compile_variant: amazon2023-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.3-arm64-large
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: .development_critical !.requires_large_host !.incompatible_community
  - name: .development_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2023.3-arm64-large
  - name: .release_critical !.requires_large_host !.incompatible_community
  - name: .release_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2023.3-arm64-large

- name: amazon2023-arm64-grav4
  display_name: "Amazon Linux 2023 arm64 Graviton 4"
  tags: ["bazel_check"]
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023-arm64-latest-small-m8g
  expansions:
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
      --use_diagnostic_latches=True
      --build_enterprise=False
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: >-
      --excludeWithAnyTags=incompatible_with_amazon_linux,requires_external_data_source,requires_latch_analyzer
      --enableEnterpriseTests=off
    has_packages: false
    repo_edition: org
    scons_cache_scope: shared
    large_distro_name: amazon2023-arm64-latest-large-m8g
    compile_variant: amazon2023-arm64-grav4
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023-arm64-latest-large-m8g
  - name: .development_critical !.requires_large_host !.incompatible_community
  - name: .development_critical .requires_large_host !.incompatible_community
    distros:
    - amazon2023-arm64-latest-large-m8g
  - name: .release_critical !.requires_large_host !.incompatible_community !.publish
  - name: .release_critical .requires_large_host !.incompatible_community !.publish
    distros:
    - amazon2023-arm64-latest-large-m8g

- &enterprise-amazon2023-arm64-template
  name: enterprise-amazon2023-arm64
  display_name: "Enterprise Amazon Linux 2023 arm64"
  tags: []
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023.3-arm64-small
  expansions:
    additional_package_targets: archive-mongocryptd-stripped archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-amazon2023
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
      --use_diagnostic_latches=True
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    has_packages: true
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: amazon2023
    repo_edition: enterprise
    compile_variant: enterprise-amazon2023-arm64
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023.3-arm64-large
  - name: test_packages
    distros:
    - ubuntu2204-arm64-large
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2023.3-arm64-large
  - name: .release_critical !.requires_large_host
  - name: .release_critical .requires_large_host
    distros:
    - amazon2023.3-arm64-large

- name: enterprise-amazon2023-arm64-grav4
  display_name: "Enterprise Amazon Linux 2023 arm64 Graviton 4"
  tags: []
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2023-arm64-latest-small-m8g
  expansions:
    additional_package_targets: archive-mongocryptd-stripped archive-mongocryptd-debug
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2023
    compile_all_but_not_unittests_flags: >-
      --linkopt=-s
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: false
    multiversion_platform: amazon2023
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    repo_edition: enterprise
    scons_cache_scope: shared
    # TODO SERVER-64479 remove external_auth_jobs_max once resolved
    external_auth_jobs_max: 1
    compile_variant: enterprise-amazon2023-arm64-grav4
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2023-arm64-latest-large-m8g
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2023-arm64-latest-large-m8g
  - name: .release_critical !.requires_large_host !.publish !.publish_crypt
  - name: .release_critical .requires_large_host !.publish !.publish_crypt
    distros:
    - amazon2023-arm64-latest-large-m8g

- name: enterprise-amazon2-arm64
  display_name: "Enterprise Amazon Linux 2 arm64"
  tags: []
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-arm64-latest-small
  expansions:
    additional_package_targets: >-
      archive-mongocryptd-stripped
      archive-mongocryptd-debug
    push_path: linux
    push_bucket: downloads.10gen.com
    push_name: linux
    push_arch: aarch64-enterprise-amazon2
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2
      --use_diagnostic_latches=False
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: true
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    packager_script: packager_enterprise.py
    packager_arch: aarch64
    packager_distro: amazon2
    repo_edition: enterprise
    compile_variant: enterprise-amazon2-arm64
    core_analyzer_distro_name: amazon2-arm64-latest-xlarge
  tasks:
  - name: compile_test_and_package_serial_no_unittests_TG
    distros:
    - amazon2-arm64-latest-large
  - name: compile_integration_and_test_parallel_stream_TG
    distros:
    - amazon2-arm64-latest-large
  - name: test_packages
    distros:
    - ubuntu1804-arm64-build
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2-arm64-latest-large
  - name: .release_critical !.requires_large_host
  - name: .release_critical .requires_large_host
    distros:
    - amazon2-arm64-latest-large

- name: enterprise-amazon2-arm64-grav4
  display_name: "Enterprise Amazon Linux 2 arm64 Graviton 4"
  tags: []
  cron: "0 4 * * *" # From the ${project_nightly_cron} parameter.
  run_on:
  - amazon2-arm64-latest-small-m8g
  expansions:
    additional_package_targets: >-
      archive-mongocryptd-stripped
      archive-mongocryptd-debug
    bazel_compile_flags: >-
      --define=MONGO_DISTMOD=amazon2
      --use_diagnostic_latches=False
    test_flags: --excludeWithAnyTags=incompatible_with_amazon_linux,requires_ldap_pool,requires_v4_0,requires_external_data_source,requires_latch_analyzer
    has_packages: false
    multiversion_platform: amazon2
    multiversion_edition: enterprise
    multiversion_architecture: aarch64
    repo_edition: enterprise
    compile_variant: enterprise-amazon2-arm64-grav4
    core_analyzer_distro_name: amazon2-arm64-latest-xlarge-m8g
  tasks:
  - name: compile_test_and_package_serial_TG
    distros:
    - amazon2-arm64-latest-large-m8g
  - name: .development_critical !.requires_large_host
  - name: .development_critical .requires_large_host
    distros:
    - amazon2-arm64-latest-large
  - name: .release_critical !.requires_large_host !.publish !.publish_crypt
  - name: .release_critical .requires_large_host !.publish !.publish_crypt
    distros:
    - amazon2-arm64-latest-large

- <<: *enterprise-amazon2023-arm64-template
  name: enterprise-amazon2023-arm64-fuzzers
  display_name: "Enterprise Amazon Linux 2023 arm64 Fuzzers"
  tags: []
  depends_on:
    - name: version_gen
      variant: generate-tasks-for-version
      # This is added because of EVG-18211.
      # Without this we are adding extra dependencies on evergreen and it is causing strain
      omit_generated_tasks: true
    - name: archive_dist_test
      variant: enterprise-amazon2023-arm64
  tasks:
    - name: .aggfuzzer !.multiversion
    - name: .change_stream_fuzzer
    - name: .query_fuzzer
    - name: .updatefuzzer !.multiversion
