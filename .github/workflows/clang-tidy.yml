name: clang-tidy

on: [pull_request]

permissions:
  contents: read
  security-events: write

env:
  CLANG_TIDY_SARIF_VERSION: "0.8.0"

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: poetry.lock

      - name: Install Python deps
        run: |
          python -m pip install -U pip "virtualenv>=20.35,<21" poetry==2.0.0
          poetry config virtualenvs.create false
          poetry install --no-root --without export

      - name: Install Bazel
        run: |
          python3 buildscripts/install_bazel.py

      - uses: actions/cache@v4
        id: bazel_cache
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: ${{ runner.os }}-bazel-cache

      - name: "Cache clang-tidy-sarif"
        uses: actions/cache@v4
        id: clang_tidy_sarif_cache
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-clang-tidy-sarif-${{ env.CLANG_TIDY_SARIF_VERSION }}

      - name: Install Rust (for clang-tidy-sarif)
        if: steps.clang_tidy_sarif_cache.outputs.cache-hit != 'true'
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install clang-tidy-sarif (cached in ~/.cargo/bin)
        if: steps.clang_tidy_sarif_cache.outputs.cache-hit != 'true'
        run: cargo install clang-tidy-sarif

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.cpp
            **/*.hpp
            **/*.h
          json: true

      - name: Create .bazelrc.compiledb
        run: |
          {
            echo 'common --config=local'
            echo 'common --build_enterprise=false'
          } > .bazelrc.compiledb

      - name: Generate compile_commands.json and build mongo_tidy_checks plugin
        run: |
          bazel --bazelrc=.bazelrc.compiledb build //:compiledb //src/mongo/tools/mongo_tidy_checks:mongo_tidy_checks

      - name: Run clang-tidy with SARIF (skip if no C++ changes)
        if: ${{ steps.changed.outputs.any_changed == 'true' }}
        env:
          FILES_JSON: ${{ steps.changed.outputs.all_changed_files }}
        run: |
          mapfile -t FILES < <(printf '%s' "$FILES_JSON" | jq -r '.[]')
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No C/C++ files changed."
            exit 0
          fi

          external/mongo_toolchain_v5/v5/bin/clang-tidy \
            --load="~/.cache/mongo_tidy_check/libmongo_tidy_checks.so" \
            "${FILES[@]}" \
          | clang-tidy-sarif --output=clang-tidy-results.sarif

      - name: Upload SARIF results
        if: always() && github.event.pull_request.head.repo.fork == false
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: clang-tidy-results.sarif
          category: clang-tidy
