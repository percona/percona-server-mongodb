name: clang-tidy
on: [pull_request]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Bazel and Tools
        uses: actions/cache@v4
        with:
          path: |
            ~/venv
            ~/.cache/bazel
            ~/.bazel-cache
            .bazel-cache
            ~/.local/bin
            ~/.cargo/bin
          key: ${{ runner.os }}-tools-${{ hashFiles('.bazelrc', '.bazelrc.compiledb', 'WORKSPACE', 'MODULE.bazel', '**/BUILD.bazel', '**/BUILD', 'Cargo.toml', 'Cargo.lock', 'poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-tools-

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies and Bazel
        run: |
          mkdir -p ~/venv
          python3 -m venv ~/venv
          source ~/venv/bin/activate
          pip3 install --upgrade pip
          python -m pip install -U "virtualenv>=20.35,<21"
          pip3 install poetry=='2.0.0'
          poetry install --no-root --without export
          echo "Installing bazel"
          python3 buildscripts/install_bazel.py

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.cpp
            **/*.cc
            **/*.cxx
            **/*.C
            **/*.c++
            **/*.cp

      - name: Show changed files
        run: |
          echo "Changed files: ${{ steps.changed.outputs.all_changed_files }}"

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
          override: true

      - name: Install clang-tidy-sarif
        run: |
          if ! command -v clang-tidy-sarif &> /dev/null; then
            cargo install clang-tidy-sarif
          else
            echo "clang-tidy-sarif already installed"
          fi

      - name: Create .bazelrc.compiledb
        run: |
          echo 'common --config=local' > .bazelrc.compiledb
          echo 'common --build_enterprise=false' >> .bazelrc.compiledb

      - name: Generate compile_commands.json
        run: |
          bazel --bazelrc=.bazelrc.compiledb build //:compiledb

      - name: Run clang-tidy with SARIF output
        run: |
          external/mongo_toolchain_v5/v5/bin/clang-tidy \
          --load="bazel-bin/src/mongo/tools/mongo_tidy_checks/libmongo_tidy_checks.so" \
          ${{ steps.changed.outputs.all_changed_files }} | clang-tidy-sarif --output=clang-tidy-results.sarif

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: clang-tidy-results.sarif
          category: clang-tidy

      - name: Save Bazel cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.bazel-cache
            .bazel-cache
            ~/.local/bin
            ~/.cargo/bin
          key: ${{ runner.os }}-tools-${{ hashFiles('.bazelrc', '.bazelrc.compiledb', 'WORKSPACE', 'MODULE.bazel', '**/BUILD.bazel', '**/BUILD', 'Cargo.toml', 'Cargo.lock') }}
